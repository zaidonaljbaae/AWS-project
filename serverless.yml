service: aws-microservices-template

custom:
  stage: ${opt:stage, self:provider.stage}
  region: ${opt:region, self:provider.region}

params:
  dev:
    VPCID: vpc-0c07cdd25c80eb7a3
    SUBNETIDS:
      - subnet-018313b2802ae2719
      - subnet-087fad512b11f8f42

    # RDS security group (must allow inbound 5432 from the Lambda SG)
    RDSSGID: sg-065b9a017b02f9a66
    DB_HOST: database.c2h2uwui8lj0.us-east-1.rds.amazonaws.com
    DB_PORT: 5432
    DB_NAME: postgres
    DB_USER: postgres
    DB_PASSWORD: Aws-0020alj.333
    ECS_TASK_SG_ID: sg-0f2049ab5b76651ae

    S3_BUCKET_NAME: dev-bucket-376129844054

    ALB_SG_ID: sg-06fac6af50507b57b
    # Cognito (User Pool)
    ISSUERURL: https://cognito-idp.us-east-1.amazonaws.com/us-east-1_6bPvMXkYd
    AUDIENCE: 21vpvaiih8133fmci5ui0g8f9g

  prod:
    VPCID: vpc-0c07cdd25c80eb7a3
    SUBNETIDS:
      - subnet-018313b2802ae2719
      - subnet-087fad512b11f8f42

    RDSSGID: sg-065b9a017b02f9a66

    S3_BUCKET_NAME: dev-bucket-376129844054
    DB_HOST: database.c2h2uwui8lj0.us-east-1.rds.amazonaws.com
    DB_PORT: 5432
    DB_NAME: postgres
    DB_USER: postgres 
    DB_PASSWORD: Aws-0020alj.333
    ECS_TASK_SG_ID: sg-0f2049ab5b76651ae

    ALB_SG_ID: sg-06fac6af50507b57b

    # Cognito (User Pool)
    ISSUERURL: https://cognito-idp.us-east-1.amazonaws.com/us-east-1_6bPvMXkYd
    AUDIENCE: 21vpvaiih8133fmci5ui0g8f9g

provider:
  name: aws
  runtime: python3.11
  versionFunctions: true
  region: ${self:custom.region}
  stage: ${opt:stage, 'dev'}
  logRetentionInDays: 30

  httpApi:
    cors: true
    authorizers:
      cognitoJwt:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl: ${param:ISSUERURL}
        audience:
          - ${param:AUDIENCE}

  vpc:
    securityGroupIds:
      - Ref: LambdaSecurityGroup
    subnetIds: ${param:SUBNETIDS}

  environment:
    ENVIRONMENT: ${self:custom.stage}
    S3_BUCKET_NAME: ${param:S3_BUCKET_NAME}

    DB_HOST: ${env:DB_HOST}
    DB_PORT: ${env:DB_PORT}
    DB_NAME: ${env:DB_NAME}
    DB_USER: ${env:DB_USER}
    DB_PASSWORD: ${env:DB_PASSWORD}

    # Useful for app-side validation (optional)
    COGNITO_ISSUER: ${param:ISSUERURL}
    COGNITO_AUDIENCE: ${param:AUDIENCE}
    ECS_TASK_SG_ID: ${param:ECS_TASK_SG_ID}
    ALB_SG_ID: ${param:ALB_SG_ID}



package:
  individually: true
  patterns:
    - '!node_modules/**'
    - '!infra/**'
    - '!.tools/**'
    - '!cdk.out/**'
    - '!**/*.tgz'
    - '!**/*.tar.gz'
    - '!**/__pycache__/**'

functions:
  example_api: ${file(src/app/example_api/example_api.yml)}
  print_lambda: ${file(src/app/print_lambda/print_lambda.yml)}

resources:
  - ${file(resources/vpc/vpc.yml)}

plugins:
  - serverless-iam-roles-per-function
  - serverless-plugin-resource-tagging
